name: Deploy to AWS EC2

on:
  push:
    branches:
    - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Make mvnw executable
      run: chmod +x mvnw

    - name: Build with Maven
      run: ./mvnw clean package -DskipTests

    - name: Deploy to AWS EC2
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        AWS_HOST: ${{ secrets.AWS_HOST }}
        AWS_USER: ${{ secrets.AWS_USER }}
      run: |
        echo "$SSH_PRIVATE_KEY" > private_key.pem
        chmod 600 private_key.pem

        # Copiar JAR al servidor
        scp -i private_key.pem -o StrictHostKeyChecking=no \
          target/*.jar $AWS_USER@$AWS_HOST:/home/$AWS_USER/usuario-service.jar

        # Ejecutar comandos en el servidor
        ssh -i private_key.pem -o StrictHostKeyChecking=no $AWS_USER@$AWS_HOST << 'EOF'
          # Reiniciar el servicio systemd
          sudo systemctl restart usuario-service
          
          # Esperar a que el servicio inicie
          sleep 5
          
          # Verificar estado del servicio
          sudo systemctl status usuario-service --no-pager
          
          echo "AplicaciÃ³n desplegada exitosamente"
        EOF

        # Limpiar archivo de clave privada
        rm -f private_key.pem
